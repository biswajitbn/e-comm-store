<div *ngIf="loading">Loading...</div>

<div *ngIf="!loading && product" class="product-details">
  <nav class="breadcrumb">
    <a routerLink="/">Home</a> /
    <a [routerLink]="['/category', product.categoryId?._id]">{{ product.categoryId?.name }}</a> /
    <span>{{ product.name }}</span>
  </nav>

  <div class="content">
    <div class="image-gallery">
      <img [src]="selectedImage || product.images?.[0]" alt="{{ product.name }}" class="main-image" />
      <div class="thumbnails">
        <img *ngFor="let img of product.images"
             [src]="img"
             (click)="selectedImage = img"
             [class.active]="img === selectedImage" />
      </div>
    </div>

    <div class="info">
      <h2>{{ product.name }}</h2>

      <div class="badges">
        <span *ngIf="product.isNewProduct" class="badge new">New</span>
        <span *ngIf="product.isFeature" class="badge featured">Featured</span>
      </div>

      <p class="short-desc">{{ product.shortDescription }}</p>

      <p class="desc">
        {{ showFullDesc ? product.description : (product.description | slice:0:300) + '...' }}
        <a (click)="showFullDesc = !showFullDesc">
          {{ showFullDesc ? 'Show Less' : 'Read More' }}
        </a>
      </p>

      <div class="price-box">
        <span class="price">₹{{ getDiscountedPrice(product.price, product.discount) }}</span>
        <span *ngIf="product.discount" class="original">₹{{ product.price }}</span>
        <span *ngIf="product.discount" class="discount">-{{ product.discount }}%</span>
      </div>

      <p class="stock" [ngClass]="{ 'in-stock': product.inStock, 'out-of-stock': !product.inStock }">
        {{ product.inStock ? 'In Stock' : 'Out of Stock' }}
      </p>

      <p><strong>Category:</strong> {{ product.categoryId?.name || '-' }}</p>
      <p><strong>Brand:</strong> {{ product.brandId?.name || '-' }}</p>

      <div class="quantity">
        <label>Quantity:</label>
        <button (click)="decreaseQty()" [disabled]="quantity <= 1">-</button>
        <input type="number" [value]="quantity" readonly />
        <button (click)="increaseQty()">+</button>
      </div>

      <div class="actions">
        <button (click)="addToCart(product, quantity)">
          <i class="fas fa-shopping-cart"></i> Add to Cart
        </button>
        <button (click)="addToWishlist(product)">
          <i class="fas fa-heart"></i> Add to Wishlist
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ✅ REVIEW SECTION -->
<div class="reviews">
  <h3>Customer Reviews</h3>

  <!-- ⭐ Rating Filter -->
  <div class="filter-group">
    <label for="ratingFilter">Filter by Rating:</label>
    <select [(ngModel)]="selectedRating" (change)="filterReviews()" id="ratingFilter">
      <option value="all">All Ratings</option>
      <option *ngFor="let r of [5,4,3,2,1]" [value]="r">
        {{ '★'.repeat(r) + ' ' + r + ' Star' + (r > 1 ? 's' : '') }}
      </option>
    </select>
  </div>

  <!-- ⭐ Review List (Scrollable Container) -->
  <div *ngIf="filteredReviews.length; else noReviews">
    <div class="reviews-scroll-container">
      <div *ngFor="let review of filteredReviews" class="review-item">
        <p class="reviewer">
          {{ review.name }}
          <span class="stars">{{ '★'.repeat(review.rating) }}{{ '☆'.repeat(5 - review.rating) }}</span>
        </p>
        <p class="comment">“{{ review.comment }}”</p>
      </div>
    </div>
  </div>

  <ng-template #noReviews>
    <p>No reviews available for this rating.</p>
  </ng-template>

  <!-- ⭐ Leave a Review -->
  <div class="review-form">
    <h4>Leave a Review</h4>
    <form (ngSubmit)="submitReview()">
      <input type="text" [(ngModel)]="newReview.name" name="name" placeholder="Your name" required />
      <select [(ngModel)]="newReview.rating" name="rating" required>
        <option value="" disabled selected>Select Rating</option>
        <option *ngFor="let r of [5,4,3,2,1]" [value]="r">
          {{ '★'.repeat(r) + ' ' + r + ' Star' + (r > 1 ? 's' : '') }}
        </option>
      </select>
      <textarea [(ngModel)]="newReview.comment" name="comment" placeholder="Your review" required></textarea>
      <button type="submit">Submit Review</button>
    </form>
  </div>
</div>

<div *ngIf="!loading && error">{{ error }}</div>
